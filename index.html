<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Math-education website redesigns — browse, search, and filter all projects.">
  <title>Math Redesigns — Project Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy:  { 950:'#080F1F', 900:'#0C1D3A', 800:'#132B50', 700:'#1E3A5F', 600:'#2B4C7E', 500:'#3A6298' },
            gold:  { 500:'#D4A017', 400:'#E8B931', 300:'#F0CC5B' },
          },
          fontFamily: { sans:['Inter','system-ui','-apple-system','sans-serif'] },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* Filter chips */
    .chip{display:inline-flex;align-items:center;gap:0.25rem;padding:0.25rem 0.625rem;border-radius:9999px;font-size:0.6875rem;line-height:1rem;font-weight:500;border:1px solid;cursor:pointer;user-select:none;transition:all 120ms ease}
    .chip-off{background:transparent;border-color:rgba(255,255,255,.08);color:rgb(148,163,184)}
    .chip-off:hover{border-color:rgba(255,255,255,.18);color:rgb(203,213,225)}
    .chip-on{background:rgba(212,160,23,.12);border-color:rgba(232,185,49,.35);color:#E8B931}

    /* Custom scrollbar */
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.14)}

    /* Row hover */
    .site-row{transition:background 120ms ease,border-color 120ms ease}

    /* Autocomplete items */
    .ac-item{transition:background 80ms ease}
    .ac-item[data-active="true"]{background:rgba(255,255,255,.06)}
  </style>
</head>
<body class="font-sans bg-navy-950 text-slate-300 antialiased min-h-screen flex flex-col">

  <!-- ====== HEADER ====== -->
  <header class="bg-navy-900/80 backdrop-blur-xl border-b border-white/[.04] sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-14">
      <a href="index.html" class="flex items-center gap-2.5 group">
        <div class="w-8 h-8 bg-gold-500 rounded-lg flex items-center justify-center group-hover:bg-gold-400 transition-colors">
          <svg class="w-[18px] h-[18px] text-navy-900" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.745 3A23.933 23.933 0 0 0 3 12c0 3.183.62 6.22 1.745 9M19.255 3C20.38 5.78 21 8.817 21 12s-.62 6.22-1.745 9m-13.51-9h12.51m-6.255-9v18"/></svg>
        </div>
        <span class="text-white font-bold tracking-tight text-[15px]">Math Redesigns</span>
      </a>
      <div class="flex items-center gap-2">
        <span id="header-count" class="text-[11px] text-slate-500 tabular-nums"></span>
        <a href="https://github.com/CMath-ProClub/Math" target="_blank" rel="noopener"
           class="p-2 rounded-lg text-slate-500 hover:text-white hover:bg-white/5 transition-colors" aria-label="GitHub">
          <svg class="w-[18px] h-[18px]" fill="currentColor" viewBox="0 0 24 24"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.11.82-.26.82-.58l-.01-2.04c-3.34.73-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.09-.75.08-.73.08-.73 1.21.08 1.85 1.24 1.85 1.24 1.07 1.84 2.81 1.31 3.5 1 .11-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.13-.3-.54-1.52.12-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6.02 0c2.28-1.55 3.29-1.23 3.29-1.23.66 1.66.25 2.88.12 3.18a4.65 4.65 0 0 1 1.24 3.22c0 4.61-2.81 5.63-5.48 5.92.43.37.81 1.1.81 2.22l-.01 3.29c0 .32.21.7.82.58A12 12 0 0 0 12 .3"/></svg>
        </a>
      </div>
    </div>
  </header>

  <!-- ====== SEARCH + AUTOCOMPLETE ====== -->
  <section class="bg-navy-900 border-b border-white/[.04]">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10">
      <h1 class="text-xl sm:text-2xl font-extrabold text-white tracking-tight">Project Hub</h1>
      <p class="mt-1.5 text-slate-400 text-sm max-w-lg">Search, filter, and navigate to any site redesign.</p>

      <div class="mt-5 relative max-w-xl" id="search-wrap">
        <div class="relative">
          <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 pointer-events-none" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/></svg>
          <input id="search" type="text" placeholder="Search sites by name, tag, or org…" autocomplete="off"
                 role="combobox" aria-expanded="false" aria-controls="ac-list" aria-autocomplete="list"
                 class="w-full pl-10 pr-20 py-2.5 bg-navy-800 border border-white/10 rounded-xl text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-gold-500/30 focus:border-gold-500/30 transition-all">
          <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1.5">
            <button id="search-clear" class="hidden p-0.5 rounded text-slate-500 hover:text-white transition-colors" aria-label="Clear search">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
            </button>
            <kbd class="hidden sm:inline-flex items-center px-1.5 py-0.5 bg-navy-700/60 border border-white/[.06] rounded text-[10px] text-slate-500 font-mono leading-none">/</kbd>
          </div>
        </div>

        <!-- Autocomplete dropdown -->
        <div id="ac-dropdown" class="hidden absolute left-0 right-0 top-full mt-1.5 bg-navy-900 border border-white/10 rounded-xl shadow-2xl shadow-black/40 overflow-hidden z-50" role="listbox" aria-label="Search suggestions">
          <ul id="ac-results" class="max-h-80 overflow-y-auto py-1"></ul>
          <div class="px-3.5 py-2 border-t border-white/[.04] text-[10px] text-slate-600 flex items-center gap-3">
            <span><kbd class="px-1 py-0.5 bg-navy-800 rounded text-slate-500 font-mono">↑↓</kbd> navigate</span>
            <span><kbd class="px-1 py-0.5 bg-navy-800 rounded text-slate-500 font-mono">↵</kbd> go to site</span>
            <span><kbd class="px-1 py-0.5 bg-navy-800 rounded text-slate-500 font-mono">esc</kbd> close</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== TOOLBAR: FILTERS + SORT ====== -->
  <section class="bg-navy-950 border-b border-white/[.04] sticky top-14 z-30">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-2.5">
      <div class="flex items-center gap-2 flex-wrap">
        <!-- Filter toggle -->
        <button id="filter-toggle" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium text-slate-400 bg-navy-900 border border-white/[.06] hover:border-white/[.12] hover:text-slate-200 transition-all">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z"/></svg>
          Filters
          <span id="filter-badge" class="hidden px-1.5 py-0.5 bg-gold-500 text-navy-900 rounded-full text-[10px] font-bold leading-none min-w-[18px] text-center"></span>
        </button>

        <!-- Active filter pills -->
        <div id="active-pills" class="flex flex-wrap gap-1.5 flex-1"></div>

        <!-- Sort -->
        <div class="flex items-center gap-1.5 ml-auto flex-shrink-0">
          <label for="sort-select" class="text-[11px] text-slate-600 hidden sm:inline">Sort</label>
          <select id="sort-select" class="bg-navy-900 border border-white/[.06] rounded-lg text-xs text-slate-400 pl-2.5 pr-7 py-1.5 focus:outline-none focus:ring-2 focus:ring-gold-500/30 cursor-pointer appearance-none" style="background-image:url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 20 20%22 fill=%22%23475569%22><path fill-rule=%22evenodd%22 d=%22M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z%22 clip-rule=%22evenodd%22/></svg>');background-position:right 0.5rem center;background-repeat:no-repeat;background-size:1rem">
            <option value="name-asc">Name A → Z</option>
            <option value="name-desc">Name Z → A</option>
            <option value="updated-desc" selected>Recently Updated</option>
            <option value="created-desc">Newest First</option>
            <option value="created-asc">Oldest First</option>
            <option value="pages-desc">Most Pages</option>
            <option value="pages-asc">Fewest Pages</option>
            <option value="complexity-desc">Complexity ↓</option>
            <option value="complexity-asc">Complexity ↑</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== FILTER PANEL (collapsible) ====== -->
  <div id="filter-panel" class="hidden bg-navy-900/50 border-b border-white/[.04]">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-5">
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-5">
        <div>
          <p class="text-[10px] font-semibold text-slate-600 uppercase tracking-widest mb-2">Tags</p>
          <div id="f-tags" class="flex flex-wrap gap-1.5 max-h-44 overflow-y-auto pr-1"></div>
        </div>
        <div>
          <p class="text-[10px] font-semibold text-slate-600 uppercase tracking-widest mb-2">Complexity</p>
          <div id="f-complexity" class="flex flex-wrap gap-1.5"></div>
        </div>
        <div>
          <p class="text-[10px] font-semibold text-slate-600 uppercase tracking-widest mb-2">Status</p>
          <div id="f-status" class="flex flex-wrap gap-1.5"></div>
        </div>
        <div>
          <p class="text-[10px] font-semibold text-slate-600 uppercase tracking-widest mb-2">Org Type</p>
          <div id="f-orgtype" class="flex flex-wrap gap-1.5"></div>
        </div>
      </div>
      <button id="clear-all" class="mt-4 text-[11px] text-slate-600 hover:text-gold-400 transition-colors">Reset all filters</button>
    </div>
  </div>

  <!-- ====== MAIN: SITE LIST ====== -->
  <main class="flex-1">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

      <!-- Results count -->
      <p id="results-info" class="text-[11px] text-slate-600 mb-3 tabular-nums"></p>

      <!-- Column headers (desktop) -->
      <div id="list-header" class="hidden sm:grid sm:grid-cols-[1fr_180px_100px_90px_80px_36px] gap-4 px-4 py-2 text-[10px] font-semibold text-slate-600 uppercase tracking-widest border-b border-white/[.04]">
        <span>Site</span>
        <span>Tags</span>
        <span>Complexity</span>
        <span>Org Type</span>
        <span>Pages</span>
        <span></span>
      </div>

      <!-- Rows go here -->
      <div id="site-list" class="divide-y divide-white/[.03]"></div>

      <!-- Empty state -->
      <div id="empty-state" class="hidden py-16 text-center">
        <svg class="w-10 h-10 text-slate-800 mx-auto mb-3" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/></svg>
        <p class="text-slate-500 text-sm font-medium">No sites match your search</p>
        <p class="text-slate-600 text-xs mt-1">Try a different query or remove some filters.</p>
        <button id="empty-reset" class="mt-3 text-xs text-gold-400 hover:text-gold-300 font-medium transition-colors">Clear everything</button>
      </div>

      <!-- Loading -->
      <div id="loading-state" class="py-16 text-center">
        <div class="w-6 h-6 border-2 border-slate-800 border-t-gold-500 rounded-full animate-spin mx-auto mb-3"></div>
        <p class="text-slate-600 text-xs">Loading sites…</p>
      </div>
    </div>
  </main>

  <!-- ====== FOOTER ====== -->
  <footer class="border-t border-white/[.03]">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-5 flex flex-col sm:flex-row justify-between items-center gap-2">
      <p class="text-[11px] text-slate-700">&copy; 2025 Carter Matherne</p>
      <div class="flex items-center gap-3 text-[11px] text-slate-700">
        <a href="https://github.com/CMath-ProClub/Math" target="_blank" rel="noopener" class="hover:text-slate-400 transition-colors">GitHub</a>
        <span class="text-slate-800">·</span>
        <a href="shared/taxonomy.json" target="_blank" class="hover:text-slate-400 transition-colors">Taxonomy</a>
        <span class="text-slate-800">·</span>
        <a href="sites/manifest.json" target="_blank" class="hover:text-slate-400 transition-colors">Manifest</a>
      </div>
    </div>
  </footer>

  <!-- ====== APPLICATION LOGIC ====== -->
  <script>
  (function () {
    'use strict';

    /* ── State ─────────────────────────────────────────── */
    let allSites   = [];
    let taxonomy   = null;
    let searchQuery = '';
    let activeTags       = new Set();
    let activeComplexity = new Set();
    let activeStatus     = new Set();
    let activeOrgType    = new Set();
    let sortKey  = 'updated-desc';
    let acIndex  = -1;                        // autocomplete highlight index

    const CX_ORDER = { simple:1, moderate:2, complex:3, enterprise:4 };

    /* ── DOM refs ──────────────────────────────────────── */
    const $ = id => document.getElementById(id);
    const dom = {
      search       : $('search'),
      searchClear  : $('search-clear'),
      acDropdown   : $('ac-dropdown'),
      acResults    : $('ac-results'),
      list         : $('site-list'),
      listHeader   : $('list-header'),
      empty        : $('empty-state'),
      loading      : $('loading-state'),
      resultsInfo  : $('results-info'),
      headerCount  : $('header-count'),
      sortSelect   : $('sort-select'),
      filterToggle : $('filter-toggle'),
      filterPanel  : $('filter-panel'),
      filterBadge  : $('filter-badge'),
      activePills  : $('active-pills'),
    };

    /* ── Init ──────────────────────────────────────────── */
    async function init () {
      try {
        const [mRes, tRes] = await Promise.all([
          fetch('sites/manifest.json'),
          fetch('shared/taxonomy.json'),
        ]);
        if (!mRes.ok || !tRes.ok) throw new Error('Fetch failed');
        const manifest = await mRes.json();
        taxonomy       = await tRes.json();
        allSites       = manifest.sites || [];
        dom.headerCount.textContent = allSites.length + (allSites.length === 1 ? ' site' : ' sites');
        buildFilters();
        render();
      } catch (e) {
        console.error(e);
        dom.loading.innerHTML = '<p class="text-red-400/80 text-xs">Failed to load data — ensure manifest.json and taxonomy.json are accessible.</p>';
      }
    }

    /* ── Build filter chips from taxonomy ──────────────── */
    function buildFilters () {
      if (!taxonomy) return;

      // Collect tags actually in use (for dim/enabled styling)
      const usedTags = new Set();
      allSites.forEach(s => (s.tags || []).forEach(t => usedTags.add(t)));

      // Tags
      const tagContainer = $('f-tags');
      for (const group of Object.values(taxonomy.tags)) {
        for (const v of group.values) {
          tagContainer.appendChild(makeChip(v, 'tag', usedTags.has(v)));
        }
      }

      // Complexity
      const cxContainer = $('f-complexity');
      for (const [key, obj] of Object.entries(taxonomy.complexity.levels)) {
        cxContainer.appendChild(makeChip(obj.label, 'complexity', true, key));
      }

      // Status
      const stContainer = $('f-status');
      for (const s of taxonomy.statuses.values) {
        stContainer.appendChild(makeChip(cap(s), 'status', true, s));
      }

      // Org type
      const otContainer = $('f-orgtype');
      for (const o of taxonomy.organizationTypes.values) {
        otContainer.appendChild(makeChip(fmtOrg(o), 'orgtype', true, o));
      }
    }

    function makeChip (label, group, enabled, value) {
      const b = document.createElement('button');
      b.type        = 'button';
      b.textContent = label;
      b.dataset.group = group;
      b.dataset.value = value || label;
      b.className   = 'chip chip-off' + (enabled ? '' : ' opacity-30 pointer-events-none');
      b.addEventListener('click', () => {
        const set = setFor(group);
        const val = b.dataset.value;
        if (set.has(val)) { set.delete(val); b.className = 'chip chip-off'; }
        else              { set.add(val);    b.className = 'chip chip-on'; }
        render();
      });
      return b;
    }

    function setFor (g) {
      if (g === 'tag')        return activeTags;
      if (g === 'complexity') return activeComplexity;
      if (g === 'status')     return activeStatus;
      return activeOrgType;
    }

    /* ── Render ────────────────────────────────────────── */
    function render () {
      dom.loading.classList.add('hidden');

      const filtered = filterSites(allSites);
      const sorted   = sortSites(filtered);

      // Results counter
      const total   = allSites.length;
      const showing = sorted.length;
      dom.resultsInfo.textContent = showing === total
        ? `All ${total} site${total !== 1 ? 's' : ''}`
        : `${showing} of ${total} site${total !== 1 ? 's' : ''}`;

      // Render list rows
      dom.list.innerHTML = '';
      sorted.forEach(site => dom.list.appendChild(buildRow(site)));

      // Toggle header / empty
      dom.listHeader.classList.toggle('hidden', showing === 0);
      dom.empty.classList.toggle('hidden', showing > 0);

      // Badge count
      const fc = activeTags.size + activeComplexity.size + activeStatus.size + activeOrgType.size;
      dom.filterBadge.textContent = fc;
      dom.filterBadge.classList.toggle('hidden', fc === 0);

      renderActivePills();
    }

    /* ── Filter logic ──────────────────────────────────── */
    function filterSites (sites) {
      return sites.filter(s => {
        // Text search
        if (searchQuery) {
          const q   = searchQuery.toLowerCase();
          const hay = [s.name, s.slug, s.organization?.name,
                       s.portfolio?.shortDescription, ...(s.tags || [])]
                      .filter(Boolean).join(' ').toLowerCase();
          if (!hay.includes(q)) return false;
        }
        // Tags (AND: must have ALL selected)
        if (activeTags.size) {
          const st = new Set(s.tags || []);
          for (const t of activeTags) { if (!st.has(t)) return false; }
        }
        // Complexity (OR)
        if (activeComplexity.size && !activeComplexity.has(s.complexity)) return false;
        // Status (OR)
        if (activeStatus.size && !activeStatus.has(s.status))            return false;
        // Org type (OR)
        if (activeOrgType.size && !activeOrgType.has(s.organization?.type)) return false;

        return true;
      });
    }

    /* ── Sort logic ────────────────────────────────────── */
    function sortSites (sites) {
      const arr = [...sites];
      const cmp = (a, b) => (a || '').localeCompare(b || '');
      switch (sortKey) {
        case 'name-asc':        return arr.sort((a,b) => cmp(a.name, b.name));
        case 'name-desc':       return arr.sort((a,b) => cmp(b.name, a.name));
        case 'updated-desc':    return arr.sort((a,b) => cmp(b.updated, a.updated));
        case 'created-desc':    return arr.sort((a,b) => cmp(b.created, a.created));
        case 'created-asc':     return arr.sort((a,b) => cmp(a.created, b.created));
        case 'pages-desc':      return arr.sort((a,b) => (b.scope?.pageCount||0) - (a.scope?.pageCount||0));
        case 'pages-asc':       return arr.sort((a,b) => (a.scope?.pageCount||0) - (b.scope?.pageCount||0));
        case 'complexity-desc': return arr.sort((a,b) => (CX_ORDER[b.complexity]||0) - (CX_ORDER[a.complexity]||0));
        case 'complexity-asc':  return arr.sort((a,b) => (CX_ORDER[a.complexity]||0) - (CX_ORDER[b.complexity]||0));
        default: return arr;
      }
    }

    /* ── Build one list row ────────────────────────────── */
    function buildRow (site) {
      const a = document.createElement('a');
      a.href      = 'sites/' + site.slug + '/index.html';
      a.className = 'site-row block sm:grid sm:grid-cols-[1fr_180px_100px_90px_80px_36px] sm:items-center gap-4 px-4 py-3.5 hover:bg-white/[.02] rounded-lg group';

      // Status colour map
      const statusColors = {
        complete      : 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20',
        deployed      : 'text-purple-400 bg-purple-500/10 border-purple-500/20',
        'in-progress' : 'text-blue-400 bg-blue-500/10 border-blue-500/20',
        review        : 'text-amber-400 bg-amber-500/10 border-amber-500/20',
        prospect      : 'text-slate-400 bg-slate-500/10 border-slate-500/15',
        paused        : 'text-orange-400 bg-orange-500/10 border-orange-500/20',
        archived      : 'text-slate-500 bg-slate-500/10 border-slate-500/15',
      };
      const stClr = statusColors[site.status] || statusColors.prospect;

      const tags      = (site.tags || []);
      const tagChips  = tags.slice(0, 3).map(t =>
        '<span class="px-1.5 py-0.5 bg-white/[.04] rounded text-[10px] text-slate-500 truncate max-w-[70px]">' + esc(t) + '</span>'
      ).join('');
      const tagMore   = tags.length > 3 ? '<span class="px-1 py-0.5 text-[10px] text-slate-600">+' + (tags.length - 3) + '</span>' : '';

      a.innerHTML =
        /* Name + status badge */
        '<div class="flex items-center gap-3 min-w-0">' +
          '<div class="min-w-0 flex-1">' +
            '<div class="flex items-center gap-2">' +
              '<span class="text-sm font-semibold text-white truncate group-hover:text-gold-400 transition-colors">' + esc(site.name) + '</span>' +
              '<span class="flex-shrink-0 px-1.5 py-0.5 rounded-full text-[10px] font-semibold border ' + stClr + '">' + cap(esc(site.status)) + '</span>' +
            '</div>' +
            '<p class="text-xs text-slate-500 truncate mt-0.5 sm:hidden">' + esc(site.portfolio?.shortDescription || '') + '</p>' +
          '</div>' +
        '</div>' +
        /* Tags (desktop) */
        '<div class="hidden sm:flex flex-wrap gap-1 overflow-hidden max-h-6">' + tagChips + tagMore + '</div>' +
        /* Complexity */
        '<span class="hidden sm:inline text-xs text-slate-400">' + cap(esc(site.complexity || '—')) + '</span>' +
        /* Org type */
        '<span class="hidden sm:inline text-xs text-slate-500">' + fmtOrg(site.organization?.type || '') + '</span>' +
        /* Page count */
        '<span class="hidden sm:inline text-xs text-slate-500 tabular-nums">' + (site.scope?.pageCount || '—') + '</span>' +
        /* Arrow */
        '<div class="hidden sm:flex justify-end">' +
          '<svg class="w-4 h-4 text-slate-700 group-hover:text-gold-500 transition-colors" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>' +
        '</div>' +
        /* Mobile meta row */
        '<div class="flex sm:hidden items-center gap-3 mt-2 text-[11px] text-slate-600">' +
          '<span>' + cap(esc(site.complexity || '')) + '</span>' +
          '<span>·</span>' +
          '<span>' + (site.scope?.pageCount || 0) + ' pages</span>' +
          '<span>·</span>' +
          '<span>' + fmtOrg(site.organization?.type || '') + '</span>' +
          '<svg class="w-3.5 h-3.5 ml-auto text-slate-700 group-hover:text-gold-500 transition-colors" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>' +
        '</div>';

      return a;
    }

    /* ── Autocomplete ──────────────────────────────────── */
    function acUpdate () {
      const q = dom.search.value.trim().toLowerCase();
      if (!q) { acHide(); return; }

      const matches = allSites.filter(s => {
        const hay = [s.name, s.slug, s.organization?.name, ...(s.tags || [])].filter(Boolean).join(' ').toLowerCase();
        return hay.includes(q);
      }).slice(0, 8);

      if (!matches.length) { acHide(); return; }

      dom.acResults.innerHTML = '';
      acIndex = -1;

      matches.forEach((site, i) => {
        const li = document.createElement('li');
        li.role = 'option';
        li.dataset.index = i;
        li.dataset.href  = 'sites/' + site.slug + '/index.html';
        li.className = 'ac-item flex items-center gap-3 px-3.5 py-2.5 cursor-pointer hover:bg-white/[.04]';
        li.innerHTML =
          '<div class="w-7 h-7 rounded-lg bg-navy-800 border border-white/[.06] flex items-center justify-center flex-shrink-0">' +
            '<span class="text-[10px] font-bold text-slate-500">' + esc(site.name.charAt(0)) + '</span>' +
          '</div>' +
          '<div class="min-w-0 flex-1">' +
            '<p class="text-sm text-white font-medium truncate">' + highlight(site.name, q) + '</p>' +
            '<p class="text-[11px] text-slate-500 truncate">' + esc(site.slug) + ' · ' + (site.tags || []).slice(0, 3).join(', ') + '</p>' +
          '</div>' +
          '<svg class="w-3.5 h-3.5 text-slate-700 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>';

        li.addEventListener('click',      () => { window.location.href = li.dataset.href; });
        li.addEventListener('mouseenter', () => { acSetActive(i); });
        dom.acResults.appendChild(li);
      });

      dom.acDropdown.classList.remove('hidden');
      dom.search.setAttribute('aria-expanded', 'true');
    }

    function acSetActive (idx) {
      const items = dom.acResults.querySelectorAll('.ac-item');
      items.forEach(el => el.dataset.active = 'false');
      acIndex = idx;
      if (idx >= 0 && idx < items.length) {
        items[idx].dataset.active = 'true';
        items[idx].scrollIntoView({ block: 'nearest' });
      }
    }

    function acHide () {
      dom.acDropdown.classList.add('hidden');
      dom.search.setAttribute('aria-expanded', 'false');
      acIndex = -1;
    }

    function acNavigate (dir) {
      const items = dom.acResults.querySelectorAll('.ac-item');
      if (!items.length) return;
      let next = acIndex + dir;
      if (next < 0)             next = items.length - 1;
      if (next >= items.length) next = 0;
      acSetActive(next);
    }

    function acSelect () {
      const items = dom.acResults.querySelectorAll('.ac-item');
      if (acIndex >= 0 && acIndex < items.length) {
        window.location.href = items[acIndex].dataset.href;
      }
    }

    function highlight (text, q) {
      const idx = text.toLowerCase().indexOf(q);
      if (idx === -1) return esc(text);
      return esc(text.slice(0, idx)) +
        '<span class="text-gold-400">' + esc(text.slice(idx, idx + q.length)) + '</span>' +
        esc(text.slice(idx + q.length));
    }

    /* ── Active filter pills (toolbar) ─────────────────── */
    function renderActivePills () {
      dom.activePills.innerHTML = '';
      const add = (label, group, value) => {
        const b = document.createElement('button');
        b.type      = 'button';
        b.className = 'inline-flex items-center gap-1 px-2 py-0.5 bg-gold-500/[.08] border border-gold-500/15 rounded-full text-[10px] font-medium text-gold-400 hover:bg-gold-500/15 transition-colors';
        b.innerHTML = esc(label) +
          '<svg class="w-2.5 h-2.5 opacity-60" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>';
        b.addEventListener('click', () => {
          setFor(group).delete(value);
          // Reset matching chip appearance
          document.querySelectorAll('[data-group="' + group + '"][data-value="' + value + '"]').forEach(c => c.className = 'chip chip-off');
          render();
        });
        dom.activePills.appendChild(b);
      };

      activeTags.forEach(v       => add(v, 'tag', v));
      activeComplexity.forEach(v => add(cap(v), 'complexity', v));
      activeStatus.forEach(v     => add(cap(v), 'status', v));
      activeOrgType.forEach(v    => add(fmtOrg(v), 'orgtype', v));
    }

    /* ── Helpers ───────────────────────────────────────── */
    function esc (s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }
    function cap (s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }
    function fmtOrg (t) {
      if (!t || t === '—') return '—';
      return t.split('-').map(cap).join(' ');
    }

    function clearAll () {
      searchQuery = '';
      dom.search.value = '';
      activeTags.clear();
      activeComplexity.clear();
      activeStatus.clear();
      activeOrgType.clear();
      document.querySelectorAll('.chip-on').forEach(c => c.className = 'chip chip-off');
      acHide();
      render();
    }

    /* ── Events ────────────────────────────────────────── */
    let debounceTimer = null;

    dom.search.addEventListener('input', () => {
      const v = dom.search.value.trim();
      searchQuery = v;
      dom.searchClear.classList.toggle('hidden', !v);
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => { render(); acUpdate(); }, 80);
    });

    dom.searchClear.addEventListener('click', () => {
      dom.search.value = '';
      searchQuery = '';
      dom.searchClear.classList.add('hidden');
      acHide();
      render();
      dom.search.focus();
    });

    // Keyboard navigation for autocomplete
    dom.search.addEventListener('keydown', e => {
      const visible = !dom.acDropdown.classList.contains('hidden');
      if (e.key === 'ArrowDown')  { e.preventDefault(); if (visible) acNavigate(1);  else acUpdate(); }
      else if (e.key === 'ArrowUp')    { e.preventDefault(); acNavigate(-1); }
      else if (e.key === 'Enter')      { e.preventDefault(); if (visible && acIndex >= 0) acSelect(); }
      else if (e.key === 'Escape')     { acHide(); dom.search.blur(); }
    });

    // Close dropdown on outside click
    document.addEventListener('click', e => {
      if (!$('search-wrap').contains(e.target)) acHide();
    });

    // Reopen on focus if there's text
    dom.search.addEventListener('focus', () => {
      if (dom.search.value.trim()) acUpdate();
    });

    // Sort select
    dom.sortSelect.addEventListener('change', e => { sortKey = e.target.value; render(); });

    // Filter panel toggle
    dom.filterToggle.addEventListener('click', () => dom.filterPanel.classList.toggle('hidden'));

    // Clear buttons
    $('clear-all').addEventListener('click', clearAll);
    $('empty-reset').addEventListener('click', clearAll);

    // Global keyboard shortcut: / to focus search
    document.addEventListener('keydown', e => {
      if (e.key === '/' && document.activeElement !== dom.search && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'SELECT') {
        e.preventDefault();
        dom.search.focus();
      }
    });

    /* ── Boot ──────────────────────────────────────────── */
    init();

  })();
  </script>

</body>
</html>
